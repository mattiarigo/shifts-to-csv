<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shift to CSV</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    ></script>
  </head>

  <body>
    <div class="container my-5">
      <h1 class="text-center mb-4">Shift to CSV</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="shift-form">
            <div class="mb-3">
              <label for="start-date" class="form-label">Start Date</label>
              <input
                type="date"
                class="form-control"
                id="start-date"
                required
              />
            </div>
            <div class="mb-3">
              <label for="shift-input" class="form-label"
                >Shift Sequence (tab-separated)</label
              >
              <input
                type="text"
                class="form-control"
                id="shift-input"
                placeholder="e.g., morning\tafternoon\tnight"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary">
              Generate Schedule
            </button>
          </form>
        </div>
      </div>

      <div id="output" class="d-none">
        <h2 class="mb-3">Generated Schedule</h2>
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Subject</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>All Day Event</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody id="schedule-body"></tbody>
        </table>
        <button id="download-btn" class="btn btn-success">
          Download Schedule
        </button>
      </div>
    </div>

    <script>
      const shifts = {
        morning: {
          subject: 'Morning',
          start_time: '07:00',
          end_time: '14:12',
          all_day_event: false,
          location: 'Bassona',
          days: 1,
        },
        afternoon: {
          subject: 'Afternoon',
          start_time: '14:10',
          end_time: '21:22',
          all_day_event: false,
          location: 'Bassona',
          days: 1,
        },
        normal: {
          subject: 'Normal',
          start_time: '08:30',
          end_time: '17:00',
          all_day_event: false,
          location: 'Bassona',
          days: 1,
        },
        evening: {
          subject: 'Evening',
          start_time: '21:15',
          end_time: '04:27',
          all_day_event: false,
          location: 'Home',
          days: 2,
        },
        night: {
          subject: 'Night',
          start_time: '00:00',
          end_time: '07:12',
          all_day_event: false,
          location: 'Home',
          days: 1,
        },
        'w-night': {
          subject: 'Night',
          start_time: '00:00',
          end_time: '08:00',
          all_day_event: false,
          location: 'Home',
          days: 1,
        },
        'w-morning': {
          subject: 'Morning',
          start_time: '08:00',
          end_time: '16:00',
          all_day_event: false,
          location: 'Home',
          days: 1,
        },
        'w-afternoon': {
          subject: 'Afternoon',
          start_time: '16:00',
          end_time: '00:00',
          all_day_event: false,
          location: 'Home',
          days: 2,
        },
        'h-night': {
          subject: 'Night',
          start_time: '00:00',
          end_time: '08:00',
          all_day_event: false,
          location: 'Home',
          days: 1,
        },
        'h-morning': {
          subject: 'Morning',
          start_time: '08:00',
          end_time: '16:00',
          all_day_event: false,
          location: 'Home',
          days: 1,
        },
        'h-afternoon': {
          subject: 'Afternoon',
          start_time: '16:00',
          end_time: '00:00',
          all_day_event: false,
          location: 'Home',
          days: 2,
        },
        off: {
          subject: 'Off',
          start_time: '00:00',
          end_time: '00:00',
          all_day_event: true,
          location: '',
          days: 1,
        },
        vacation: {
          subject: 'Vacation',
          start_time: '00:00',
          end_time: '00:00',
          all_day_event: true,
          location: '',
          days: 1,
        },
      };

      document
        .getElementById('shift-form')
        .addEventListener('submit', function (e) {
          e.preventDefault();

          const startDate = new Date(
            document.getElementById('start-date').value
          );
          const shiftSequence = document
            .getElementById('shift-input')
            .value.split('\t')
            .map((s) => s.trim());
          const scheduleBody = document.getElementById('schedule-body');
          const rows = [];

          scheduleBody.innerHTML = '';
          let currentDate = new Date(startDate);

          // Add CSV headers
          rows.push(
            'Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location'
          );

          shiftSequence.forEach((shiftKey) => {
            const shift = shifts[shiftKey];
            if (!shift) return;

            const endDate = new Date(currentDate);
            endDate.setDate(endDate.getDate() + (shift.days - 1));

            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${shift.subject}</td>
                    <td>${currentDate.toISOString().split('T')[0]}</td>
                    <td>${endDate.toISOString().split('T')[0]}</td>
                    <td>${shift.start_time}</td>
                    <td>${shift.end_time}</td>
                    <td>${shift.all_day_event}</td>
                    <td>${shift.location}</td>
                `;
            scheduleBody.appendChild(row);

            // Push row data to CSV
            rows.push(
              `${shift.subject},${currentDate.toISOString().split('T')[0]},${
                shift.start_time
              },${endDate.toISOString().split('T')[0]},${shift.end_time},${
                shift.all_day_event
              },,"${shift.location}"`
            );

            currentDate.setDate(currentDate.getDate() + 1);
          });

          document.getElementById('output').classList.remove('d-none');

          document.getElementById('download-btn').onclick = function () {
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule.csv';
            a.click();
            URL.revokeObjectURL(url);
          };
        });
    </script>
  </body>
</html>
